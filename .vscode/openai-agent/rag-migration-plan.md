# VS Code OpenAI Agent - RAG Migration Plan

## Обзор проекта
Переход с Assistants API на Chat Completions API с интеграцией локального RAG (Retrieval-Augmented Generation) для сохранения долгосрочного контекста разработки.

## Выбранная технология RAG
**LangChain.js + ChromaDB**
- Лицензии: MIT (LangChain) + Apache 2.0 (ChromaDB) - коммерческое использование разрешено
- Простота интеграции с TypeScript/Node.js
- Готовые компоненты для работы с OpenAI
- Встраиваемая векторная база данных
- Оптимальный баланс производительности и простоты

## Архитектурные изменения

### 1. Новые компоненты
- `RAGManager` - управление векторным хранилищем и поиском
- `DecisionManager` - управление принятыми решениями
- `OpenAIChatService` - новый сервис для Chat Completions API
- `VectorStore` - работа с ChromaDB
- `EmbeddingService` - генерация эмбеддингов через OpenAI

### 2. Структура данных
```typescript
interface VectorEntry {
  id: string;
  text: string;
  embedding: number[];
  metadata: {
    type: 'code' | 'comment' | 'decision' | 'chat' | 'image';
    timestamp: string;
    path?: string;
    decisionId?: string;
    chatId?: string;
    tags?: string[];
  }
}

interface Decision {
  id: string;
  title: string;
  description: string;
  reasoning: string;
  timestamp: string;
  tags: string[];
  relatedCode?: string[];
}
```

### 3. Хранение данных
- **Векторные данные**: ChromaDB коллекции
- **Метаданные**: JSON файлы в `.vscode/openai-agent/`
- **Изображения**: файловая система + метаданные в ChromaDB
- **История чатов**: структурированные JSON файлы

## Этапы реализации

### Этап 1: Базовая инфраструктура (5-6 дней)
1. Установка зависимостей: `langchain`, `chromadb`
2. Создание `RAGManager` класса
3. Реализация `VectorStore` с ChromaDB
4. Создание `EmbeddingService` для OpenAI
5. Базовая система индексации текста

### Этап 2: Chat Completions API (5-6 дней)
1. Создание `OpenAIChatService` класса
2. Адаптация существующих инструментов
3. Интеграция с MCP-сервером
4. Реализация обработки вызовов функций
5. Система управления контекстом с RAG

### Этап 3: UI и интеграция (4-5 дней)
1. Обновление UI для нового API
2. Панель истории чатов
3. Интерфейс управления решениями
4. Визуализация связей между решениями
5. Поиск по контексту

### Этап 4: Тестирование и оптимизация (3-4 дня)
1. Тестирование всех функций
2. Оптимизация производительности
3. Исправление ошибок
4. Документация

## Ключевые функции RAG

### 1. Индексация кода
- Автоматическая индексация при изменениях
- Семантический поиск по кодовой базе
- Связывание решений с кодом

### 2. Управление решениями
- Явное сохранение принятых решений
- Метаданные о причинах и обоснованиях
- Связи между решениями

### 3. Контекстный поиск
- Поиск релевантного кода по запросу
- Извлечение связанных решений
- История предыдущих обсуждений

### 4. Работа с изображениями
- Сохранение изображений из чата
- Генерация описаний через GPT-4V
- Векторный поиск по содержимому изображений

## Преимущества подхода

1. **Долгосрочная память** - агент помнит все решения и их обоснования
2. **Контекстное понимание** - понимание структуры проекта
3. **Последовательность** - согласованность рекомендаций
4. **Эффективность** - не нужно повторно объяснять контекст
5. **Обучаемость** - улучшение на основе истории проекта

## Технические детали

### Зависимости
```json
{
  "langchain": "^0.1.0",
  "chromadb": "^1.7.0",
  "@langchain/openai": "^0.0.14"
}
```

### Структура файлов
```
.vscode/openai-agent/
├── rag/
│   ├── vector_index.bin
│   ├── metadata.json
│   └── images/
├── decisions/
│   └── *.json
├── chats/
│   └── *.json
└── config.json
```

## Риски и митигация

### Риск: Производительность индексации
**Митигация**: Инкрементальная индексация, фоновые задачи

### Риск: Размер векторного хранилища
**Митигация**: Сжатие эмбеддингов, очистка старых данных

### Риск: Сложность интеграции
**Митигация**: Поэтапная реализация, тестирование на каждом этапе

## Следующие шаги

1. Утверждение плана
2. Создание прототипа RAGManager
3. Установка зависимостей
4. Начало реализации Этапа 1

---
*Создано: $(date)*
*Статус: Планирование*
